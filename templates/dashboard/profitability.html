{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>ðŸ“ˆ Profitability & Cash Dashboard</h2>

{% if not years %}
  <div class="alert alert-warning">Nenalezeny Å¾Ã¡dnÃ© vÃ½sledovky.</div>
{% else %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ðŸ”¹ Data do JSON (bezpeÄnÄ› pomocÃ­ json_script) -->
{{ years|json_script:"years-data" }}
{{ revenue|json_script:"revenue-data" }}
{{ cogs|json_script:"cogs-data" }}
{{ overheads|json_script:"overheads-data" }}
{{ gross_margin|json_script:"gm-data" }}
{{ ebit|json_script:"ebit-data" }}
{{ net_profit|json_script:"np-data" }}
{{ gross_margin_pct|json_script:"gm-pct-data" }}
{{ operating_profit_pct|json_script:"op-pct-data" }}
{{ net_profit_pct|json_script:"np-pct-data" }}
{{ revenue_growth_pct|json_script:"rev-yoy-data" }}
{{ cogs_growth_pct|json_script:"cogs-yoy-data" }}
{{ overheads_growth_pct|json_script:"ovh-yoy-data" }}
{{ cash_from_customers|json_script:"cfc-data" }}
{{ cash_to_suppliers|json_script:"cts-data" }}
{{ gross_cash_profit|json_script:"gcp-data" }}
{{ ocf|json_script:"ocf-data" }}

<div class="row g-4">
  <div class="col-12">
    <h4>Revenue vs COGS vs Overheads</h4>
    <canvas id="revCogsOver"></canvas>
  </div>

  <div class="col-12">
    <h4>Gross Margin + EBIT + Net Profit</h4>
    <canvas id="profitBlocks"></canvas>
  </div>

  <div class="col-12">
    <h4>Margins %</h4>
    <canvas id="marginsPct"></canvas>
  </div>

  <div class="col-12">
    <h4>YoY Growth %</h4>
    <canvas id="yoyGrowth"></canvas>
  </div>

  <div class="col-12">
    <h4>Cash Side</h4>
    <canvas id="cashSide"></canvas>
  </div>
</div>

<script>
  // ðŸ”¹ NaÄtenÃ­ dat z json_script
  const YEARS   = JSON.parse(document.getElementById("years-data").textContent);
  const revenue = JSON.parse(document.getElementById("revenue-data").textContent);
  const cogs    = JSON.parse(document.getElementById("cogs-data").textContent);
  const overheads = JSON.parse(document.getElementById("overheads-data").textContent);
  const gm      = JSON.parse(document.getElementById("gm-data").textContent);
  const ebit    = JSON.parse(document.getElementById("ebit-data").textContent);
  const np      = JSON.parse(document.getElementById("np-data").textContent);

  const gmPct   = JSON.parse(document.getElementById("gm-pct-data").textContent);
  const opPct   = JSON.parse(document.getElementById("op-pct-data").textContent);
  const npPct   = JSON.parse(document.getElementById("np-pct-data").textContent);

  const revYoY  = JSON.parse(document.getElementById("rev-yoy-data").textContent);
  const cogsYoY = JSON.parse(document.getElementById("cogs-yoy-data").textContent);
  const ovhYoY  = JSON.parse(document.getElementById("ovh-yoy-data").textContent);

  const cfc = JSON.parse(document.getElementById("cfc-data").textContent);
  const cts = JSON.parse(document.getElementById("cts-data").textContent);
  const gcp = JSON.parse(document.getElementById("gcp-data").textContent);
  const ocf = JSON.parse(document.getElementById("ocf-data").textContent);

  // ðŸ”¹ Helper â€“ pÅ™evede dict {year: value} na pole podle YEARS
  function values(dict) {
    return YEARS.map(y => dict[y] ?? null);
  }

  // === Grafy ===
  new Chart(document.getElementById('revCogsOver'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Revenue', data: values(revenue), borderColor: 'green' },
        { label: 'COGS', data: values(cogs), borderColor: 'red' },
        { label: 'Overheads', data: values(overheads), borderColor: 'orange' },
      ]
    }
  });

  new Chart(document.getElementById('profitBlocks'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Gross Margin', data: values(gm), borderColor: 'blue' },
        { label: 'EBIT', data: values(ebit), borderColor: 'purple' },
        { label: 'Net Profit', data: values(np), borderColor: 'black' },
      ]
    }
  });

  new Chart(document.getElementById('marginsPct'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Gross Margin %', data: values(gmPct) },
        { label: 'Operating Profit %', data: values(opPct) },
        { label: 'Net Profit %', data: values(npPct) },
      ]
    }
  });

  new Chart(document.getElementById('yoyGrowth'), {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Revenue YoY %', data: values(revYoY) },
        { label: 'COGS YoY %', data: values(cogsYoY) },
        { label: 'Overheads YoY %', data: values(ovhYoY) },
      ]
    }
  });

  new Chart(document.getElementById('cashSide'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Cash from Customers', data: values(cfc) },
        { label: 'Cash to Suppliers', data: values(cts) },
        { label: 'Gross Cash Profit', data: values(gcp) },
        { label: 'Operating Cash Flow', data: values(ocf) },
      ]
    }
  });
</script>
{% endif %}
{% endblock %}
