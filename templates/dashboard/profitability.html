{% extends "base.html" %}
{% load static %}
{% load json_extras %}

{% block content %}
<h2>ðŸ“ˆ Profitability & Cash Dashboard</h2>

{% if not years %}
  <div class="alert alert-warning">Nenalezeny Å¾Ã¡dnÃ© vÃ½sledovky.</div>
{% else %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Debug vÃ½pis -->
<pre>
YEARS = {{ years|tojson|safe }}
Revenue = {{ revenue|tojson|safe }}
COGS = {{ cogs|tojson|safe }}
Gross Margin = {{ gross_margin|tojson|safe }}
EBIT = {{ ebit|tojson|safe }}
Net Profit = {{ net_profit|tojson|safe }}
</pre>

<div class="row g-4">
  <div class="col-12">
    <h4>Revenue vs COGS vs Overheads</h4>
    <canvas id="revCogsOver"></canvas>
  </div>

  <div class="col-12">
    <h4>Gross Margin + EBIT + Net Profit</h4>
    <canvas id="profitBlocks"></canvas>
  </div>

  <div class="col-12">
    <h4>Margins %</h4>
    <canvas id="marginsPct"></canvas>
  </div>

  <div class="col-12">
    <h4>YoY Growth %</h4>
    <canvas id="yoyGrowth"></canvas>
  </div>

  <div class="col-12">
    <h4>Cash Side</h4>
    <canvas id="cashSide"></canvas>
  </div>
</div>

<script>
  // Data z Django
  const YEARS = {{ years|tojson|safe }};
  const revenue   = {{ revenue|tojson|safe }};
  const cogs      = {{ cogs|tojson|safe }};
  const overheads = {{ overheads|tojson|safe }};
  const grossMargin = {{ gross_margin|tojson|safe }};
  const ebit        = {{ ebit|tojson|safe }};
  const netProfit   = {{ net_profit|tojson|safe }};
  const gmPct   = {{ gross_margin_pct|tojson|safe }};
  const opPct   = {{ operating_profit_pct|tojson|safe }};
  const npPct   = {{ net_profit_pct|tojson|safe }};
  const revYoY  = {{ revenue_growth_pct|tojson|safe }};
  const cogsYoY = {{ cogs_growth_pct|tojson|safe }};
  const ovhYoY  = {{ overheads_growth_pct|tojson|safe }};
  const cfc  = {{ cash_from_customers|tojson|safe }};
  const cts  = {{ cash_to_suppliers|tojson|safe }};
  const gcp  = {{ gross_cash_profit|tojson|safe }};
  const ocf  = {{ ocf|tojson|safe }};

  // Helper â€“ pÅ™evede dict {year: value} na pole v poÅ™adÃ­ YEARS
  function values(dict) {
    return YEARS.map(y => dict[String(y)] ?? null);
  }

  // === Grafy ===
  new Chart(document.getElementById('revCogsOver'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Revenue', data: values(revenue) },
        { label: 'COGS', data: values(cogs) },
        { label: 'Overheads', data: values(overheads) },
      ]
    }
  });

  new Chart(document.getElementById('profitBlocks'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Gross Margin', data: values(grossMargin) },
        { label: 'EBIT', data: values(ebit) },
        { label: 'Net Profit', data: values(netProfit) },
      ]
    }
  });

  new Chart(document.getElementById('marginsPct'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Gross Margin %', data: values(gmPct) },
        { label: 'Operating Profit %', data: values(opPct) },
        { label: 'Net Profit %', data: values(npPct) },
      ]
    }
  });

  new Chart(document.getElementById('yoyGrowth'), {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Revenue YoY %', data: values(revYoY) },
        { label: 'COGS YoY %', data: values(cogsYoY) },
        { label: 'Overheads YoY %', data: values(ovhYoY) },
      ]
    }
  });

  new Chart(document.getElementById('cashSide'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Cash from Customers', data: values(cfc) },
        { label: 'Cash to Suppliers', data: values(cts) },
        { label: 'Gross Cash Profit', data: values(gcp) },
        { label: 'Operating Cash Flow', data: values(ocf) },
      ]
    }
  });
</script>
{% endif %}
{% endblock %}
