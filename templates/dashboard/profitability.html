{% extends "base.html" %}
{% load static %}
{% load json_extras %}

{% block content %}
<h2>ðŸ“ˆ Profitability & Cash Dashboard</h2>

{% if not years %}
  <div class="alert alert-warning">Nenalezeny Å¾Ã¡dnÃ© vÃ½sledovky.</div>
{% else %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="row g-4">
  <div class="col-12">
    <h4>Revenue vs COGS vs Overheads</h4>
    <canvas id="revCogsOver"></canvas>
  </div>

  <div class="col-12">
    <h4>Gross Margin (abs) + EBIT + Net Profit</h4>
    <canvas id="profitBlocks"></canvas>
  </div>

  <div class="col-12">
    <h4>Margins % (Gross, Operating, Net)</h4>
    <canvas id="marginsPct"></canvas>
  </div>

  <div class="col-12">
    <h4>YoY Growth % (Revenue / COGS / Overheads)</h4>
    <canvas id="yoyGrowth"></canvas>
  </div>

  <div class="col-12">
    <h4>Cash Side (indicative)</h4>
    <canvas id="cashSide"></canvas>
  </div>
</div>

<script>
  // âœ… Data z Django â†’ validnÃ­ JSON dÃ­ky filtru tojson
  const YEARS = {{ years|tojson }};
  const revenue   = {{ revenue|tojson }};
  const cogs      = {{ cogs|tojson }};
  const overheads = {{ overheads|tojson }};

  const grossMargin = {{ gross_margin|tojson }};
  const ebit        = {{ ebit|tojson }};
  const netProfit   = {{ net_profit|tojson }};

  const gmPct   = {{ gross_margin_pct|tojson }};
  const opPct   = {{ operating_profit_pct|tojson }};
  const npPct   = {{ net_profit_pct|tojson }};

  const revYoY  = {{ revenue_growth_pct|tojson }};
  const cogsYoY = {{ cogs_growth_pct|tojson }};
  const ovhYoY  = {{ overheads_growth_pct|tojson }};

  const cfc  = {{ cash_from_customers|tojson }};
  const cts  = {{ cash_to_suppliers|tojson }};
  const gcp  = {{ gross_cash_profit|tojson }};
  const ocf  = {{ ocf|tojson }};
  // const ncf  = {{ net_cash_flow|tojson }};

  // Helper pro pÅ™evod dict {rok: hodnota} â†’ array v poÅ™adÃ­ YEARS
  function arr(dict) {
    return YEARS.map(y => dict[String(y)] ?? dict[y] ?? null);
  }

  // === Grafy ===
  new Chart(document.getElementById('revCogsOver'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Revenue', data: arr(revenue) },
        { label: 'COGS', data: arr(cogs) },
        { label: 'Overheads', data: arr(overheads) },
      ]
    }
  });

  new Chart(document.getElementById('profitBlocks'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Gross Margin', data: arr(grossMargin) },
        { label: 'EBIT (Operating Profit)', data: arr(ebit) },
        { label: 'Net Profit', data: arr(netProfit) },
      ]
    }
  });

  new Chart(document.getElementById('marginsPct'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Gross Margin %', data: arr(gmPct) },
        { label: 'Operating Profit %', data: arr(opPct) },
        { label: 'Net Profit %', data: arr(npPct) },
      ]
    }
  });

  new Chart(document.getElementById('yoyGrowth'), {
    type: 'bar',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Revenue YoY %', data: arr(revYoY) },
        { label: 'COGS YoY %', data: arr(cogsYoY) },
        { label: 'Overheads YoY %', data: arr(ovhYoY) },
      ]
    }
  });

  new Chart(document.getElementById('cashSide'), {
    type: 'line',
    data: {
      labels: YEARS,
      datasets: [
        { label: 'Cash from Customers', data: arr(cfc) },
        { label: 'Cash to Suppliers', data: arr(cts) },
        { label: 'Gross Cash Profit', data: arr(gcp) },
        { label: 'Operating Cash Flow', data: arr(ocf) },
      ]
    }
  });
</script>
{% endif %}
{% endblock %}
